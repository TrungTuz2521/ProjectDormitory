@model KTX.Entities.TienDienNuoc
@{
    ViewData["Title"] = "Chi Tiết Hóa Đơn Điện Nước";
    Layout = "~/Views/Shared/Layoutadmin.cshtml";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-primary">
                    <i class="fas fa-file-invoice me-2"></i>Chi Tiết Hóa Đơn Điện Nước
                </h2>
                <a asp-action="Index" asp-route-loai="diennuoc" asp-route-dotTtdn="@Model.DotTtdn"
                   class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </a>
            </div>

            <!-- Thông tin hóa đơn phòng -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Thông Tin Hóa Đơn
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Mã hóa đơn:</th>
                                    <td><span class="badge bg-primary">HD-@Model.MaHddn</span></td>
                                </tr>
                                <tr>
                                    <th>Phòng:</th>
                                    <td class="fw-bold text-primary">@Model.MaP</td>
                                </tr>
                                <tr>
                                    <th>Đợt thanh toán:</th>
                                    <td><span class="badge bg-dark">Tháng @Model.DotTtdn</span></td>
                                </tr>
                                <tr>
                                    <th>Ngày ghi:</th>
                                    <td>@Model.Httdn?.ToString("dd/MM/yyyy")</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Trạng thái:</th>
                                    <td>
                                        <span class="badge @(Model.TrangThaiTtdn == "Đã thanh toán" ? "bg-success" : "bg-warning text-dark") fs-6">
                                            @Model.TrangThaiTtdn
                                        </span>
                                    </td>
                                </tr>
                                @if (Model.TrangThaiTtdn == "Đã thanh toán" && Model.NgayTtdn.HasValue)
                                {
                                    <tr>
                                        <th>Ngày thanh toán:</th>
                                        <td class="text-success fw-bold">
                                            <i class="fas fa-check-circle me-1"></i>
                                            @Model.NgayTtdn?.ToString("dd/MM/yyyy")
                                        </td>
                                    </tr>
                                }
                                <tr>
                                    <th>Số người trong phòng:</th>
                                    <td class="fw-bold">@Model.ChiTietThanhToanDienNuocs?.Count người</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chi tiết tiêu thụ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>Điện
                            </h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm mb-0">
                                <tr>
                                    <td>Số điện tiêu thụ:</td>
                                    <td class="text-end fw-bold">@Model.SoDien kWh</td>
                                </tr>
                                <tr>
                                    <td>Đơn giá:</td>
                                    <td class="text-end">@Model.GiaDien?.ToString("N0") VNĐ/kWh</td>
                                </tr>
                                <tr class="border-top">
                                    <td><strong>Thành tiền:</strong></td>
                                    <td class="text-end">
                                        <strong class="text-danger fs-5">@Model.TienDien?.ToString("N0") VNĐ</strong>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-tint me-2"></i>Nước
                            </h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm mb-0">
                                <tr>
                                    <td>Số nước tiêu thụ:</td>
                                    <td class="text-end fw-bold">@Model.SoNuoc m³</td>
                                </tr>
                                <tr>
                                    <td>Đơn giá:</td>
                                    <td class="text-end">@Model.GiaNuoc?.ToString("N0") VNĐ/m³</td>
                                </tr>
                                <tr class="border-top">
                                    <td><strong>Thành tiền:</strong></td>
                                    <td class="text-end">
                                        <strong class="text-danger fs-5">@Model.TienNuoc?.ToString("N0") VNĐ</strong>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tổng tiền phòng -->
            <div class="alert alert-warning shadow-sm">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>Tổng Tiền Phòng
                    </h5>
                    <h3 class="mb-0 text-danger fw-bold">
                        @Model.TongTienDn?.ToString("N0") VNĐ
                    </h3>
                </div>
            </div>

            <!-- Chi tiết thanh toán từng sinh viên -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Chi Tiết Thanh Toán Sinh Viên
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (Model.ChiTietThanhToanDienNuocs != null && Model.ChiTietThanhToanDienNuocs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>STT</th>
                                        <th>Mã SV</th>
                                        <th>Họ tên</th>
                                        <th class="text-end">Số tiền phải trả</th>
                                        <th class="text-end">Số tiền đã trả</th>
                                        <th class="text-center">Trạng thái</th>
                                        <th class="text-center">Ngày TT</th>
                                        <th class="text-center">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        int stt = 1;
                                        decimal tongDaThu = 0;
                                        int soDaThu = 0;
                                    }
                                    @foreach (var chiTiet in Model.ChiTietThanhToanDienNuocs.OrderBy(ct => ct.Msv))
                                    {
                                        if (chiTiet.TrangThai == "Đã thanh toán")
                                        {
                                            tongDaThu += chiTiet.SoTienDaTra ?? 0;
                                            soDaThu++;
                                        }
                                        <tr>
                                            <td>@stt</td>
                                            <td><span class="badge bg-secondary">@chiTiet.Msv</span></td>
                                            <td class="fw-bold">@chiTiet.MsvNavigation?.HoTen</td>
                                            <td class="text-end fw-bold text-primary">
                                                @chiTiet.SoTienPhai.ToString("N0") VNĐ
                                            </td>
                                            <td class="text-end">
                                                @if (chiTiet.SoTienDaTra.HasValue)
                                                {
                                                    <span class="text-success fw-bold">@chiTiet.SoTienDaTra?.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <span class="badge @(chiTiet.TrangThai == "Đã thanh toán" ? "bg-success" : "bg-warning text-dark")">
                                                    @chiTiet.TrangThai
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                @if (chiTiet.NgayThanhToan.HasValue)
                                                {
                                                    <small class="text-success">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        @chiTiet.NgayThanhToan?.ToString("dd/MM/yyyy")
                                                    </small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                @if (chiTiet.TrangThai != "Đã thanh toán")
                                                {
                                                    <a href="@Url.Action("ThanhToanDienNuocCaNhan", new { maCtttdn = chiTiet.MaCtttdn })"
                                                       class="btn btn-sm btn-success">
                                                        <i class="fas fa-money-bill"></i> Thanh toán
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span class="text-success">
                                                        <i class="fas fa-check-circle"></i>
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                        stt++;
                                    }
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="3" class="text-end">TỔNG CỘNG:</td>
                                        <td class="text-end text-primary">@Model.TongTienDn?.ToString("N0") VNĐ</td>
                                        <td class="text-end text-success">@tongDaThu.ToString("N0") VNĐ</td>
                                        <td class="text-center">
                                            <span class="badge @(soDaThu == Model.ChiTietThanhToanDienNuocs.Count ? "bg-success" : "bg-info")">
                                                @soDaThu/@Model.ChiTietThanhToanDienNuocs.Count
                                            </span>
                                        </td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-info-circle fa-3x mb-3"></i>
                            <p>Chưa có chi tiết thanh toán cho hóa đơn này</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Tính toán chi tiết -->
            @if (Model.ChiTietThanhToanDienNuocs != null && Model.ChiTietThanhToanDienNuocs.Any())
            {
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Thống Kê
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="p-3 bg-light rounded">
                                    <h3 class="text-primary mb-2">@Model.ChiTietThanhToanDienNuocs.Count</h3>
                                    <small class="text-muted">Tổng sinh viên</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 bg-success bg-opacity-10 rounded">
                                    <h3 class="text-success mb-2">@Model.ChiTietThanhToanDienNuocs.Count(ct => ct.TrangThai == "Đã thanh toán")</h3>
                                    <small class="text-muted">Đã thanh toán</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 bg-warning bg-opacity-10 rounded">
                                    <h3 class="text-warning mb-2">@Model.ChiTietThanhToanDienNuocs.Count(ct => ct.TrangThai != "Đã thanh toán")</h3>
                                    <small class="text-muted">Chưa thanh toán</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 bg-light rounded">
                                    <h3 class="text-danger mb-2">
                                        @{
                                            var tiLe = Model.ChiTietThanhToanDienNuocs.Count > 0
                                            ? (Model.ChiTietThanhToanDienNuocs.Count(ct => ct.TrangThai == "Đã thanh toán") * 100.0 / Model.ChiTietThanhToanDienNuocs.Count)
                                            : 0;
                                        }
                                        @tiLe.ToString("F1")%
                                    </h3>
                                    <small class="text-muted">Tỷ lệ thu</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Nút hành động -->
            <div class="mt-4 d-flex gap-2 justify-content-end">
                <a asp-action="Index" asp-route-loai="diennuoc" asp-route-dotTtdn="@Model.DotTtdn"
                   class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
                </a>
                @if (Model.TrangThaiTtdn != "Đã thanh toán")
                {
                    <button type="button" class="btn btn-info" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>In hóa đơn
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-hide success message
        setTimeout(() => {
            const alert = document.querySelector('.alert-success');
            if (alert) new bootstrap.Alert(alert).close();
        }, 5000);
    </script>
}

<style>
    @@media print {
        .btn, .card-header, nav, footer {
            display: none !important;
        }
    }
</style>